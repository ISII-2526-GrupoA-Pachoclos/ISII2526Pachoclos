@page "/Compras/CrearCompra"

@inject NavigationManager navigation
@using AppForSEII2526.Web.Components.Shared
@using AppForSEII2526.Web.API
@inject AppForHerramientasAPIClient apiclient

@inject ILogger<CrearCompra> logger

@inject ComprasStateContainer comprasStateContainer

<h3>CrearCompra</h3>

<EditForm Model="nuevaCompra" OnValidSubmit="OpenDialog">
    <div class="row">

        <DataAnnotationsValidator />
        <ValidationSummary />
    </div>
    <div class="row g-3">
        <div class="col-md">
            <div class="form-floating mb-3">
                <InputText @bind-Value="nuevaCompra.Nombre" class="form-control" id="Nombre" />
                <label for="Nombre">Nombre </label>
            </div>
        </div>
        <div class="col-md">
            <div class="form-floating mb-3">
                <InputText @bind-Value="nuevaCompra.Apellido" class="form-control" id="Apellido" />
                <label for="Apellido">Apellido </label>
            </div>
        </div>
        <div class="col-md">
            <div class="form-floating mb-3">
                <InputText @bind-Value="nuevaCompra.DireccionEnvio" class="form-control" id="DireccionEnvio" />
                <label for="DireccionEnvio">Direccion de envío</label>
            </div>
        </div>
        <div class="col-md">
            <div class="form-floating mb-3">
                <InputText @bind-Value="nuevaCompra.NumTelefono" class="form-control" id="numTelefono" />
                <label for="numTelefono">Numero de teléfono</label>
            </div>
        </div>
        <div class="col-md">
            <div class="form-floating mb-3">
                <InputText @bind-Value="nuevaCompra.CorreoElectronico" class="form-control" id="CorreoElectronico" />
                <label for="CorreoElectronico">Correo Electrónico</label>
            </div>
        </div>

        <div class="col-md">
            <div class="form-floating">
                @*Un drop menú para seleccionar el metodo de pago*@
                <InputSelect class="form-select" @bind-Value="@nuevaCompra.MetodoPago" id="TiposMetodoPago">
                    <option value="@TiposMetodoPago.Tarjeta" default> Tarjeta</option>
                    <option value="@TiposMetodoPago.PayPal"> PayPal</option>
                    <option value="@TiposMetodoPago.Efectivo"> Efectivo</option>
                </InputSelect>
                <label for="TiposMetodoPago">Metodo de Pago</label>
            </div>
        </div>

    </div>

        <div class="col-md">
            <div class="form-floating">
                @*this button will be used to ask the user if he want to proceed to rent the movies*@
                <button class="btn btn-primary" type="submit" id="Submit">
                    Compra tus herramientas
                </button>
            </div>
        </div>
    
    <h4>Detalle de la Compra</h4>
    <p>
        <b>Total price:</b> @PrecioTotal €
        <button class="btn btn-outline-primary" type="submit" @onclick="ModificarCompraItems " id="modificarHerramientas">
            Modificar  Compra
        </button>
    </p>

    <div class="mh-100 table-responsive">
        <table class="table table-condensed table-hover" id="TableOfRentalItems">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Material</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in nuevaCompra.HerramientasCompradas)
                {
                    <tr id="MovieData_@item.Nombre">
                        <td>@item.Nombre</td>
                        <td>@item.Material</td>
                        <td>@item.Precio</td>
                        <td><InputNumber @bind-Value="item.Cantidad" class="form-control" id="@($"cantidad_{item.Herramientaid}")" /></td>
                        <td><InputText @bind-Value="item.Descripcion" class="form-control" id="@($"description_{item.Herramientaid}")" /></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</EditForm>

@if (DialogIsOpen)
{
    <Dialog Caption="Comprar Herramientas"
            Message="¿Quieres comprar las herramientas que has seleccionado?"
            OnClose="@OnDialogClose"
            Type=Dialog.Category.SaveNot>
    </Dialog>
}


@code {

    private string messageError = "";
    private bool hideErrors { get { return messageError.Length == 0; } }

    private decimal PrecioTotal
    {

        get
        {
            double precio = nuevaCompra.HerramientasCompradas.Sum(ci => ci.Precio * ci.Cantidad);
            return Convert.ToDecimal(precio);
        }

    }
    private void ModificarCompraItems()
    {
        navigation.NavigateTo("/Compras/SelectHerramientasForCompra");
    }

    private CrearCompraDTO nuevaCompra => comprasStateContainer.Compra;

    private bool DialogIsOpen;

    

    private object? errors;

    private void OpenDialog()
    {

        DialogIsOpen = true;
    }

    private async Task OnDialogClose(bool isOk)
    {

        DialogIsOpen = false;
        if (isOk)
        {
             if (nuevaCompra.HerramientasCompradas.Count > 0)
            {
                try
                {
                    var compra = await apiclient.CrearCompraAsync(nuevaCompra);
                    comprasStateContainer.ClearCarritoCompra();
                    navigation.NavigateTo($"/Compras/GetDetallesCompra/?CompraID={compra.Id}");
                }
                catch (ApiException<ValidationProblemDetails> apiexceptionvalidation)
                {

                    if (apiexceptionvalidation.Result.Errors.Values != null)
                    {
                        messageError = "";
                        foreach (var errors in apiexceptionvalidation.Result.Errors.Values)
                            //https://learn.microsoft.com/en-us/dotnet/api/system.string.join?view=net-7.0
                            messageError = string.Join("(*) ", messageError, string.Join(" (*) ", errors));
                    }
                }
                catch (ApiException apiexception)
                {
                    //we need to inform user that there was some other error while processing the request
                    messageError = "Error while processing your request, please try again later!";

                }

            }

        }
    }


}
