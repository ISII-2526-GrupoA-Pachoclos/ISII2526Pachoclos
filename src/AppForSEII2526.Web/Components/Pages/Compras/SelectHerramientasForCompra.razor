@page "/Compras/SelectHerramientasForCompra"

@using AppForSEII2526.Web.API
@inject AppForHerramientasAPIClient apiclient
@inject ILogger<SelectHerramientasForCompra> logger
@inject ComprasStateContainer comprasStateContainer
@inject NavigationManager navigation



<h3>SelectHerramientasForCompra</h3>
<div class="container-fluid">
    <div class="row alert alert-danger" role="alert" hidden="@hideErrors">
        <p id="ErrorsShown">Errors: @errors</p>
    </div>
    <div class="row">
        <div class="col-8">
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Precio</span>
                        <input type="text" id="filtroPrecio" @bind=filtroPrecio class="form-control" placeholder="Title" aria-label="Filtro Precio" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">Nombre</span>
                        <input type="text" id="filtroMaterial" @bind=filtroMaterial class="form-control" placeholder="Material" aria-label="Material" aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="col">
                    <button type="button" class="btn btn-primary" @onclick=@BuscaHerramientas id="buscarHerramientas">Buscar Herramientas</button>
                </div>
                
                @if (herramientas == null)
                {
                    <p>Cargando herramientas....</p>
                }
                else
                {
                    <div class="mh-100 table-responsive">
                        <table class="table table-condensed table-hover" id="Tabla de Herramientas">
                            <thead>
                                <tr>
                                    <th>Id</th>
                                    <th>Nombre</th>
                                    <th>Fabricante </th>
                                    <th>Precio</th>
                                    
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var herramienta in herramientas)
                                {
                                    <tr id="HerramientaData_@herramienta.Id">
                                        <td>@herramienta.Nombre</td>
                                        <td>@herramienta.Fabricante</td>
                                        <td>@herramienta.Material</td>
                                        <td>@herramienta.Precio</td>
                                        <td>
                                            <button class="btn btn-outline-secondary" id="HerramientaParaComprar_@herramienta.Nombre" @onclick="@(() => AddHerramienta(herramienta))">Add</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                }
            </div>
        </div>
        <div class="col-2" hidden="@hideCart">
            <div class="row">
                <h3>Carrito de compras</h3>
            </div>
            @foreach (CompraItemDTO item in compraDTO.HerramientasCompradas)
            {
                <div class="row">
                    <button type="button" class="btn btn-light" id="removeHerramienta_@item.Nombre" @onclick="@(() => RemoveHerramientaItem(item))">  - @item.Nombre </button>
                </div>
            }
            <div class="row">
                <button type="button" class="btn btn-primary" id="compraButton" @onclick=@comprarHerramientas>Comprar Herramientas</button>
            </div>
        </div>

    </div>

</div>

@code {
    private ICollection<HerramientasParaComprarDTO> herramientas;
    private bool hideErrors { get { return errors.Length == 0; } }
    private string errors = "";
    private string filtroMaterial { get; set; }
    private float filtroPrecio { get; set; }

    private CrearCompraDTO compraDTO => comprasStateContainer.Compra;


    private bool hideCart { get { return compraDTO.HerramientasCompradas.Count == 0; } }

    private bool hiddenCart = true;

    private void AddHerramienta(HerramientasParaComprarDTO compra)
    {
        comprasStateContainer.AddHerramientatoComprar(compra);

    }

    private void RemoveHerramientaItem(CompraItemDTO item)
    {
        comprasStateContainer.EliminarItemCompra(item);


    }


    public async void BuscaHerramientas()
    {


        try
        {
            if (filtroPrecio == 0)
            {
                herramientas = await apiclient.GetHerramientasParaComprarconTodosLosDatosDTOAsync(null, filtroMaterial);
            }
            else
            {
            
                herramientas = await apiclient.GetHerramientasParaComprarconTodosLosDatosDTOAsync(filtroPrecio, filtroMaterial);
            
            }

        }
        catch (ApiException ex)
        {
            logger.LogError($"{DateTime.Now} Error: {ex}");
            errors = "Error while connecting to the system";
        }
        StateHasChanged();


    }

    protected override Task OnInitializedAsync()
    {
        BuscaHerramientas();
        return base.OnInitializedAsync();
    }

    private void comprarHerramientas()
    {


        navigation.NavigateTo("/Compras/CrearCompra");
        
    
    }

}
